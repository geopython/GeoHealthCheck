name: build âš™ï¸
# Main GHC CI workflow. Inspired by
# https://github.com/geopython/pycsw/blob/master/.github/workflows/main.yml
#
# Author: Just van den Broecke - 2021
#

on: [ push, pull_request ]

jobs:
  main:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        include:
          - python-version: 3.7
          # - python-version: 3.8
    steps:
    - name: Checkout âœ…
      uses: actions/checkout@v2

    - name: Setup Python ${{ matrix.python-version }} ğŸ
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install requirements ğŸ“¦
      run: |
        pip3 install -r requirements.txt
        pip3 install -r requirements-dev.txt
        paver setup

    - name: Create GHC App and init DB ğŸ—ƒï¸
      run:  echo -e "admin\ntest\ntest\nyou@example.com\nyou@example.com" | python GeoHealthCheck/models.py create

    - name: Flake8 verify coding standards âš™ï¸
      run: flake8

    - name: Load Fixtures Test Data âš™ï¸
      run: python GeoHealthCheck/models.py load tests/data/fixtures.json y

    - name: Run probes âš™ï¸
      run: python GeoHealthCheck/healthcheck.py

    - name: Run Unit Tests âš™ï¸
      run: python tests/run_tests.py

    - name: Build docs ğŸ“–
      run: cd docs && make html

    - name: Cleanup ğŸ’¯
      run: python GeoHealthCheck/models.py drop
