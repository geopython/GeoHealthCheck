{% extends "layout.html" %}

{% block body %}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h1 class="page-header">{{ resource.title }}
        {% if g.user.is_authenticated() %}
        <a href="{{ url_for('test', resource_identifier=resource.identifier) }}"><button type="button" class="btn btn-primary btn-sm">Test</button></a>
        {% endif %}
        {% if g.user.role == 'admin' or g.user.username == resource.owner.username %}
        <a href="{{ url_for('delete', resource_identifier=resource.identifier) }}"><button id="confirm-delete" type="button" class="btn btn-danger btn-sm">Eliminar</button></a>
        {% endif %}
    </h1>
    
    <div class="table-responsive col-md-4">
        <table class="table">
            <tr>
                <th>Tipo</th>
                <td>{{ resource_types[resource.resource_type]['label'] }}</td>
            </tr>
            <tr>
                <th>Usuario</th>
                <td>{{ resource.owner.username }}</td>
            </tr>
            <tr>
                <th>
                    Nombre
                    {% if g.user.role == 'admin' or g.user.username == resource.owner.username %}
						<a id="title_edit" class="editar btn btn-default btn-sm glyphicon glyphicon-pencil" title="Modificar"></a>
                    {% endif %}
                </th>
                <td id="resource_title">{{ resource.title }}</td>
            </tr>
            <tr>
                <th>
					URL
					{% if g.user.role == 'admin' or g.user.username == resource.owner.username %}
						<a id="url_edit" class="editar btn btn-default btn-sm glyphicon glyphicon-pencil" title="Editar"></a>
                    {% endif %}
                </th>
                <td id="resource_url" ><a href="{{ resource.get_capabilities_url }}" id="resource_url_href">{{ resource.url }}</a></td>
            </tr>
            <tr>
                <th>
                    Correos de notificación
                    {% if g.user.role == 'admin' or g.user.username == resource.owner.username %}
						<a id="notification_mails_edit" class="editar btn btn-default btn-sm glyphicon glyphicon-pencil" title="Editar"></a>
                    {% endif %}
                </th>                
                <td id="notification_mails_text">
					{% for contact in contacts %}
						<span class="span_item_contact">{{contact.contact_value}} </span><br/>
					{% endfor %}
					
                </td>
            </tr>
            <tr>
                <th>Promedio de tiempo de respuesta (segundos)</th>
                <td>{{ resource.average_response_time|round(2) }}</td>
            </tr>
            <tr>
                <th>Fiabilidad</th>
                <td>
                    <button class="btn btn-{{ resource.reliability| cssize_reliability }} btn-sm">{{ resource.reliability|round2 }}%</button>
                </td>
            </tr>
        </table>
    </div>
    <div class="row">
        <div class="col-lg-3 col-md-4">
            <div id="resource-map" class="resource-map"></div>
        </div>
        <div class="col-lg-4 col-md-4">
        <pre>
			{{ resource.snippet() }}
        </pre>
        <a class="btn btn-default btn-xs" href="{{ url_for('json-resource', identifier=resource.identifier) }}"><span class="fa fa-download"></span> JSON</a> 
        <a class="btn btn-default btn-xs" href="{{ url_for('csv-resource', identifier=resource.identifier) }}"><span class="fa fa-download"></span> CSV</a>
        </div>
    </div>
    <div class="clearfix"></div>
    <div id="run-chart" class="run-chart"></div>
    <div>
        <h2 class="sub-header">
			Historial
			<a class="btn btn-default btn-xs" href="{{ url_for('json-resource-history', identifier=resource.identifier) }}"><span class="fa fa-download"></span> JSON</a> 
			<a class="btn btn-default btn-xs" href="{{ url_for('csv-resource-history', identifier=resource.identifier) }}"><span class="fa fa-download"></span> CSV</a>
        </h2>
        <table id="resource-table" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tiempo de respuesta (segundos)</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
            {% for run in resource.runs|sort(reverse=True, attribute='checked_datetime') %}
                <tr>
                    <td>{{ run.checked_datetime.strftime('%Y-%m-%dT%H:%M:%SZ') }}</td>
                    <td>{{ run.response_time|round(2) }}</td>
                    {% if run.success %}
                    <td><button type="button" class="btn btn-success btn-circle"><i class="fa fa-check"></i></button></td>
                    {% else %}
                    <td><button title="{{ run.message }}" type="button" class="btn btn-danger btn-circle btn"><i class="fa fa-times"></i></button></td>
                    {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block extrafoot %}
<script type="text/javascript">
	var itemCount = 0;
    var idEdit = null;
    
    {% if g.user.is_authenticated() %}
    $('#confirm-delete').click(function() {
        if (confirm('Eliminar el recurso "{{ resource.title }}"?') === false) {
            return false;
        }
    });
    {% endif %}

    $('#resource-table').dataTable({
        'paging': true,
        'ordering': false,
        'searching': false,
        'lengthChange': false,
        'language': {
            'url': "{{ url_for('static', filename='lib/bower_components/datatables-plugins/i18n/Spanish.lang') }}"
        }
    });

    $('#title_edit').click(function() {
        var title_value = $('#resource_title').html();
        // catch/stop recursive display
        if (title_value.search('<input') > -1) {
            return false;
        }
        var html_text = '<input type="text" id="input_resource_title" name="resource_title_value" value="' + title_value + '"/>';
        html_text += '<button id="title_save" type="button" class="btn btn-default btn-xs">Guardar</button>';
        html_text += '<button id="title_cancel" type="button" class="btn btn-default btn-xs">Cancelar</button>';

        $('#resource_title').html(html_text);

        $('#title_cancel').click(function() {
            $('#resource_title').html(title_value);
            return false;
        });

        $('#title_save').click(function() {
            var new_title = $('input[name="resource_title_value"]').val();
            $('#resource_title').html(new_title);
            $.ajax({
                type: "POST",
                url: "{{ url_for('update', resource_identifier=resource.identifier) }}",
                data: JSON.stringify({ title: new_title }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){alert(data);},
                failure: function(errMsg) {
                    alert(errMsg);
                }
            });
            return false;
        });
    });
    
    // Modificando el url
    $('#url_edit').click(function() {
        var url_value = $('#resource_url').html();
        console.log("url_value "+url_value);
        // catch/stop recursive display
        if (url_value.search('<input') > -1) {
            return false;
        }
        var url_val_href = $('#resource_url_href').html();
        var html_text = '<input type="text" id="input_resource_url" name="resource_url_value" value="' + url_val_href + '"/>';
        html_text += '<button id="url_save" type="button" class="btn btn-default btn-xs">Guardar</button>';
        html_text += '<button id="url_cancel" type="button" class="btn btn-default btn-xs">Cancelar</button>';

        $('#resource_url').html(html_text);

        $('#url_cancel').click(function() {
            $('#resource_url').html(url_value);
            return false;
        });

        $('#url_save').click(function() {
            var new_url = $('input[name="resource_url_value"]').val();
            
            var new_url_href = '<a href="'+new_url+'" id="resource_url_href">'+new_url+'</a>';
            $('#resource_url').html(new_url_href);
            $.ajax({
                type: "POST",
                url: "{{ url_for('update', resource_identifier=resource.identifier) }}",
                data: JSON.stringify({ url: new_url }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){alert(data);},
                failure: function(errMsg) {
                    alert(errMsg);
                }
            });
            return false;
        });
    });
    
    $('#notification_mails_edit').click(function() {
        var notification_mails_value = $('#notification_mails_text').html();
        // catch/stop recursive display
        // Para verificar si ya se presiono el boton editar, y no volver a renderizar
        if (notification_mails_value.search('<input') > -1) {
            return false;
        }
        
        itemCount = 0;
        var html_text = '<div class="form-group input-group col-sm-5">'
						+' <input id="txtMail" type="text" value="" placeholder="Correo de notificación"/>'
						+' <input id="addMailBtn" type="button" value="Guardar" class="btn btn-default btn-xs" />'
						+'</div>'
						+'<div id="mailList" class="form-group input-group col-sm-5">';
		// Adicionamos los correos.
		$('.span_item_contact').each(function() {
			itemCount = itemCount + 1 ;
			html_text += '<div> <span id="mail_'+itemCount+'" class="span_new_item_contact" style="min-width: 200px;width: 200px; display: inline-block;">'+$(this).html()+'</span>';
			html_text += '<a href="#" class="editar glyphicon glyphicon-pencil" title="Modificar"></a> ';
			html_text += '<a href="#" class="remove glyphicon glyphicon-trash" title="Eliminar"></a></div>';		
        });
		
		
		html_text += '</div>';
	
        html_text += '<button id="notification_mails_save" type="button" class="btn btn-default btn-xs">Guardar</button>';
        html_text += '<button id="notification_mails_cancel" type="button" class="btn btn-default btn-xs">Cancelar</button>';

        $('#notification_mails_text').html(html_text);
        
        $("#addMailBtn").on('click', function (e) {
			e.preventDefault();
			var mailItem = $("#txtMail").val();
			if(!isEmail(mailItem.trim()))
			{
				alert("El valor "+mailItem+", no es un correo válido");
				return false;
			}
			if (idEdit === null || idEdit === '')
			{
				$("#mailList").append('<div>' + '<span id="mail_' + itemCount + '" class="span_new_item_contact" style="min-width: 200px;width: 200px; display: inline-block;">' + mailItem 
				+ '</span> <a href="#" class="editar glyphicon glyphicon-pencil" title="Modificar"></a>'
				+ '<a href="#" class="remove glyphicon glyphicon-trash" title="Eliminar"></a></div>');
				
				itemCount = itemCount + 1;
			}
			else
			{
				$("#"+idEdit).html(mailItem);
			}
			$("#txtMail").val("");
			idEdit = null;
			return (false);
			/*$("#count").text=("li").length;*/
		});
    
        $("#notification_mails_text").on('click', '.remove', function () {
			$(this).closest('div').remove();
			$("#txtMail").val("");
			idEdit = null;
			return false;
		});
		
		$("#notification_mails_text").on('click', '.editar', function () {
			$("#txtMail").val($(this).closest('div').find('span').html());
			idEdit = $(this).closest('div').find('span').attr("id");
			return false;
		});
    
        $('#notification_mails_cancel').click(function() {
            $('#notification_mails_text').html(notification_mails_value);
            return false;
        });
		
		//Enviar informacion con REST AJAX
        $('#notification_mails_save').click(function() {
			// Contruir la vista actualizada y Construir el json para enviar a modificar.
			var new_notification_mail = "";
			var jsonObj = [];
			$('.span_new_item_contact').each(function() {
				jsonObj.push($(this).html());
				new_notification_mail += '<span class="span_item_contact">'+$(this).html()+'</span><br/>';
			});
			$('#notification_mails_text').html(new_notification_mail);
			jsonString = JSON.stringify({ emails: jsonObj});
			
			$.ajax({
				type: "POST",
				url: "{{ url_for('update', resource_identifier=resource.identifier) }}",
				data: JSON.stringify({ emails: jsonObj}),
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function(data){alert(data);},
				failure: function(errMsg) {
					alert(errMsg);
				}
			});
            return false;
        });
    });

    var run_data = {{ resource.runs_to_json()|safe }};
    Morris.Area({
        element: 'run-chart',
        lineWidth: 1,
        data: run_data,
        xkey: 'datetime',
        ykeys: ['value'],
        labels: ['Tiempo de Respuesta'],
        fillOpacity: 0.05,
        hideHover: true,
        resize: true,
        pointStrokeColors: ['black'],
        pointSize: 5,
        postUnits: ' segundos',
        dateFormat: function (x) { return new Date(x).toString(); },
        xLabelAngle: 45,
        xLabels: 'day',
        lineColors: function(row, series, ttype) {
            if (row !== null) {
                if (row.src.success === 1) {
                    return '#5CB85C';
                } else {
                    return '#D9534F';
                }
            }
            return '#00f';
        }
    });

    var map = L.map('resource-map').setView([{{ resource.latitude }}, {{ resource.longitude }}], 1);

    map.addLayer(new L.TileLayer(
        'http://otile{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
            maxZoom: 18,
            subdomains: '1234',
        }
    ));
    L.marker([{{ resource.latitude }}, {{ resource.longitude }}]).addTo(map)
    
function isEmail(email) {
  var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
  return regex.test(email);
}
</script>
{% endblock %}
